<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vaughan - dApp Proxy</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body, html {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    
    #dapp-iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-family: system-ui, -apple-system, sans-serif;
      color: #64748b;
      display: none;
    }
  </style>
</head>
<body>
  <div id="loading">Loading dApp...</div>
  <iframe id="dapp-iframe" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox"></iframe>

  <script type="module">
    // Get dApp URL from query parameter
    const params = new URLSearchParams(window.location.search);
    const dappUrl = params.get('url');
    
    if (!dappUrl) {
      document.getElementById('loading').textContent = 'Error: No dApp URL provided';
      document.getElementById('loading').style.display = 'block';
      throw new Error('No dApp URL provided');
    }
    
    console.log('[Proxy] Loading dApp:', dappUrl);
    
    // Load dApp in iframe
    const iframe = document.getElementById('dapp-iframe');
    iframe.src = dappUrl;
    
    // Hide loading when iframe loads
    iframe.onload = () => {
      console.log('[Proxy] dApp loaded');
      document.getElementById('loading').style.display = 'none';
    };
    
    // Show loading on error
    iframe.onerror = () => {
      document.getElementById('loading').textContent = 'Error loading dApp';
      document.getElementById('loading').style.display = 'block';
    };
    
    // ========================================================================
    // Provider Bridge (Proxy between iframe and Tauri)
    // ========================================================================
    
    // Wait for Tauri API to be ready
    function waitForTauri(callback, maxAttempts = 50) {
      let attempts = 0;
      const checkTauri = () => {
        attempts++;
        if (typeof window.__TAURI__ !== 'undefined') {
          console.log('[Proxy] Tauri API ready after', attempts, 'attempts');
          callback();
        } else if (attempts < maxAttempts) {
          setTimeout(checkTauri, 100);
        } else {
          console.error('[Proxy] Tauri API not available after', maxAttempts, 'attempts');
          document.getElementById('loading').textContent = 'Error: Tauri API not available';
          document.getElementById('loading').style.display = 'block';
        }
      };
      checkTauri();
    }
    
    // Initialize bridge after Tauri is ready
    waitForTauri(() => {
      initializeBridge();
    });
    
    function initializeBridge() {
      // Import Tauri API
      const { invoke } = window.__TAURI__.core;
      const { listen } = window.__TAURI__.event;
      
      console.log('[Proxy] Tauri API available:', typeof invoke !== 'undefined');
      
      // Listen for messages from iframe (dApp requests)
      window.addEventListener('message', async (event) => {
        // Only accept messages from our iframe
        if (event.source !== iframe.contentWindow) {
          return;
        }
        
        const message = event.data;
        
        // Handle Vaughan provider requests
        if (message.type === 'VAUGHAN_REQUEST') {
          console.log('[Proxy] Received request from dApp:', message.request);
          
          try {
            // Forward to Tauri backend
            const response = await invoke('dapp_request', {
              request: message.request
            });
            
            console.log('[Proxy] Received response from Tauri:', response);
            
            // Send response back to iframe
            iframe.contentWindow.postMessage({
              type: 'VAUGHAN_RESPONSE',
              id: message.request.id,
              result: response.result,
              error: response.error
            }, '*');
          } catch (error) {
            console.error('[Proxy] Error forwarding request:', error);
            
            // Send error back to iframe
            iframe.contentWindow.postMessage({
              type: 'VAUGHAN_RESPONSE',
              id: message.request.id,
              error: {
                message: error.message || 'Request failed'
              }
            }, '*');
          }
        }
      });
      
      // Listen for Tauri events and forward to iframe
      listen('accountsChanged', (event) => {
        console.log('[Proxy] accountsChanged:', event.payload);
        iframe.contentWindow.postMessage({
          type: 'VAUGHAN_EVENT',
          event: 'accountsChanged',
          data: event.payload
        }, '*');
      });
      
      listen('chainChanged', (event) => {
        console.log('[Proxy] chainChanged:', event.payload);
        iframe.contentWindow.postMessage({
          type: 'VAUGHAN_EVENT',
          event: 'chainChanged',
          data: event.payload
        }, '*');
      });
      
      listen('disconnect', (event) => {
        console.log('[Proxy] disconnect:', event.payload);
        iframe.contentWindow.postMessage({
          type: 'VAUGHAN_EVENT',
          event: 'disconnect',
          data: event.payload
        }, '*');
      });
      
      console.log('[Proxy] Bridge initialized');
    }
  </script>
</body>
</html>
